plugins {
    id 'io.micronaut.application' version '4.4.4'
}

version = '1.0.0-SNAPSHOT'
group   = 'com.knowledgeos'

repositories {
    mavenCentral()
}

micronaut {
    version '4.7.6'
    runtime 'netty'
    testRuntime 'junit5'
    processing {
        incremental true
        annotations 'com.knowledgeos.*'
    }
}

dependencies {
    // ── BOM (Bill of Materials) ───────────────────────────────────────────
    implementation platform('io.micronaut.platform:micronaut-platform:4.7.6')
    annotationProcessor platform('io.micronaut.platform:micronaut-platform:4.7.6')
    testImplementation platform('io.micronaut.platform:micronaut-platform:4.7.6')
    testAnnotationProcessor platform('io.micronaut.platform:micronaut-platform:4.7.6')

    // ── Annotation processors ─────────────────────────────────────────────
    annotationProcessor 'io.micronaut:micronaut-http-validation'
    annotationProcessor 'io.micronaut.data:micronaut-data-processor'
    annotationProcessor 'io.micronaut.openapi:micronaut-openapi'
    annotationProcessor 'io.micronaut.validation:micronaut-validation-processor'
    annotationProcessor 'io.micronaut.serde:micronaut-serde-processor'

    // ── HTTP Server ────────────────────────────────────────────────────────
    implementation 'io.micronaut:micronaut-http-server-netty'
    implementation 'io.micronaut.serde:micronaut-serde-jackson'
    implementation 'io.micronaut.validation:micronaut-validation'

    // ── Data / DB ──────────────────────────────────────────────────────────
    implementation 'io.micronaut.data:micronaut-data-hibernate-jpa'
    implementation 'io.micronaut.sql:micronaut-jdbc-hikari'
    implementation 'io.micronaut.flyway:micronaut-flyway'
    runtimeOnly     'org.postgresql:postgresql'
    runtimeOnly     'org.flywaydb:flyway-database-postgresql'   // Flyway 10+ requires explicit PG module

    // ── WebSocket ─────────────────────────────────────────────────────────
    implementation 'io.micronaut:micronaut-websocket'

    // ── Redis ─────────────────────────────────────────────────────────────
    implementation 'io.micronaut.redis:micronaut-redis-lettuce'

    // ── Kubernetes (fabric8) ──────────────────────────────────────────────
    implementation 'io.fabric8:kubernetes-client:6.13.4'

    // ── OpenAPI / Swagger ─────────────────────────────────────────────────
    // Note: micronaut-openapi annotation processor generates Swagger spec at compile time
    implementation 'io.micronaut.openapi:micronaut-openapi-annotations'
    compileOnly     'io.swagger.core.v3:swagger-annotations'

    // ── Jackson / JSON ────────────────────────────────────────────────────
    implementation 'com.fasterxml.jackson.core:jackson-databind'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'

    // ── Logging ───────────────────────────────────────────────────────────
    runtimeOnly 'ch.qos.logback:logback-classic'

    // ── Test ──────────────────────────────────────────────────────────────
    testImplementation 'io.micronaut.test:micronaut-test-junit5'
    testImplementation 'io.micronaut:micronaut-http-client'         // @Client("/")
    testImplementation 'org.junit.jupiter:junit-jupiter-api'
    testRuntimeOnly    'org.junit.jupiter:junit-jupiter-engine'
    testImplementation 'org.assertj:assertj-core'
    testImplementation 'org.mockito:mockito-core'
    // Testcontainers kept for future CI use; tests currently use docker-compose postgres
    testImplementation 'org.testcontainers:postgresql'
    testImplementation 'org.testcontainers:junit-jupiter'
    testImplementation('io.rest-assured:rest-assured') {
        exclude group: 'org.hamcrest'   // Avoid assertThat ambiguity with AssertJ
    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

tasks.withType(JavaCompile).configureEach {
    options.compilerArgs += ['-parameters']
}

tasks.withType(Test).configureEach {
    // Allow Mockito/ByteBuddy to work on Java 25 (class version 69, officially supported up to 24)
    jvmArgs '-Dnet.bytebuddy.experimental=true'
}
